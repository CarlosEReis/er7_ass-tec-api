package br.com.carloser7.asstecnica.domain.service;import br.com.carloser7.asstecnica.domain.exception.ChamadoTecnicoNaoEncontradoException;import br.com.carloser7.asstecnica.domain.model.ChamadoTecnico;import br.com.carloser7.asstecnica.domain.model.Contato;import br.com.carloser7.asstecnica.domain.model.Usuario;import br.com.carloser7.asstecnica.domain.repository.ChamadoTecnicoRepository;import net.sf.jasperreports.engine.*;import net.sf.jasperreports.engine.data.JRBeanCollectionDataSource;import net.sf.jasperreports.engine.util.JRSaver;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.core.context.SecurityContextHolder;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.io.InputStream;import java.util.ArrayList;import java.util.Collections;import java.util.List;@Servicepublic class CadastroChamadoTecnicoService {    @Autowired private ChamadoTecnicoRepository chamadoRepository;    @Autowired private CadastroClienteService clienteService;    @Autowired private CadastroContatoService contatoService;    @Autowired private CadastroProdutoService produtoService;    public ChamadoTecnico buscar(Integer chamadoId) {        return this.chamadoRepository            .findById(chamadoId)            .orElseThrow(                () -> new ChamadoTecnicoNaoEncontradoException(chamadoId));    }    @Transactional    public ChamadoTecnico criar(ChamadoTecnico chamado) {        validaChamado(chamado);        chamado.enviarParaFila(getUsuarioAtual());        return this.chamadoRepository.save(chamado);    }    private void validaChamado(ChamadoTecnico chamado) {        var cliente = clienteService.buscar(chamado.getCliente().getId());        chamado.setCliente(cliente);        validaItens(chamado);        validaContatos(chamado);    }    private void validaItens(ChamadoTecnico chamado) {        chamado.getItens().forEach(item -> {            var produto = produtoService.buscaPorIDOuFalha(item.getProduto().getId());            item.setProduto(produto);            item.setChamadoTecnico(chamado);            item.pendente(getUsuarioAtual());        });    }    private void validaContatos(ChamadoTecnico chamado) {        var contatos = new ArrayList<Contato>();        chamado.getContatos().forEach(c -> {            var contato = contatoService.buscar(c.getId());            contatos.add(contato);        });        chamado.setContatos(contatos);    }    private String getUsuarioAtual() {        Usuario usuario = (Usuario) SecurityContextHolder.getContext().getAuthentication().getDetails();        return  usuario.getNome();    }    public byte[] geraFichaChamdo(Integer chamadoId) throws JRException {        ChamadoTecnico chamadoTecnico = this.buscar(chamadoId);        return this.relatorioFichaChamadoTecnico(chamadoTecnico);    }    public  byte[] relatorioFichaChamadoTecnico (ChamadoTecnico chamado) throws JRException {        List<ChamadoTecnico> chamadoTecnicos = Collections.singletonList(chamado);        InputStream fichaChamado = getClass().getResourceAsStream("/relatorios/ficha-chamado.jrxml");        JasperReport jasperReport = JasperCompileManager.compileReport(fichaChamado);        JRSaver.saveObject(jasperReport, "ficha-chamado.jasper");        InputStream contatos = getClass().getResourceAsStream("/relatorios/ficha-chamado-contatos-embed.jrxml");        JRSaver.saveObject(JasperCompileManager.compileReport(contatos), "ficha-chamado-contatos-embed.jasper");        InputStream ocorrencias = getClass().getResourceAsStream("/relatorios/ficha-chamado-ocorrencias-embed.jrxml");        JRSaver.saveObject(JasperCompileManager.compileReport(ocorrencias), "ficha-chamado-ocorrencias-embed.jasper");        JasperPrint jasperPrint = JasperFillManager            .fillReport(jasperReport, null, new JRBeanCollectionDataSource(chamadoTecnicos));        return JasperExportManager.exportReportToPdf(jasperPrint);    }}